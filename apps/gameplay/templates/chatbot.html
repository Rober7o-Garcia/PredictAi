{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual - PredictaAI</title>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
    <link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
</head>
<body>
    {% csrf_token %}
    
    <div class="chat-container">
        <!-- üìú SIDEBAR CON HISTORIAL -->
        <div class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-header">
                <h4>üí¨ Conversaciones</h4>
                <button class="btn btn-primary btn-sm" onclick="nuevaConversacion()">
                    ‚ûï Nuevo Chat
                </button>
            </div>
            
            <div class="conversaciones-list">
                {% for conv in conversaciones %}
                <a href="#" 
                   data-conversacion-id="{{ conv.id }}"
                   onclick="event.preventDefault(); NavigationManager.loadConversation({{ conv.id }}); return false;"
                   class="conversacion-item {% if conv.id == conversacion_actual.id %}active{% endif %}">
                    <div class="conv-titulo">{{ conv.titulo }}</div>
                    <div class="conv-fecha">{{ conv.fecha_actualizacion|date:"d/m/Y H:i" }}</div>
                    <button class="btn-delete" onclick="eliminarConversacion(event, {{ conv.id }})">üóëÔ∏è</button>
                </a>
                {% empty %}
                <p class="text-muted text-center mt-3">No hay conversaciones</p>
                {% endfor %}
            </div>
        </div>

        <!-- üí¨ CHAT PRINCIPAL -->
        <div class="chat-fullscreen">
            <!-- ‚úÖ HEADER UNIFICADO CON BADGE DE INSIGHTS -->
            <div class="chatbot-header">
                <!-- Bot√≥n toggle sidebar -->
                <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Mostrar/Ocultar conversaciones">
                    <svg id="menuIcon" class="toggle-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                    <svg id="closeIcon" class="toggle-icon hidden" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>

                <!-- Info del chatbot -->
                <div class="chatbot-header-info">
                    <div class="chatbot-avatar">AI</div>
                    <div>
                        <h3 class="chatbot-title">{{ conversacion_actual.titulo }}</h3>
                        <div class="chatbot-status">
                            <span class="status-dot"></span>
                            <span>En l√≠nea</span>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ BADGE DE INSIGHTS (nuevo) -->
                <div class="header-actions">
                    {% if insights_pendientes %}
                    <button id="insightsButton" class="insights-badge-btn" onclick="abrirModalInsights()" title="Ver insights detectados">
                        <span class="badge-icon">üîî</span>
                        <span class="badge-count">{{ insights_pendientes.count }}</span>
                    </button>
                    {% endif %}
                    
                    <!-- Bot√≥n volver al dashboard -->
                    <a href="{% url 'companies:dashboard' %}" class="chatbot-close" title="Volver al dashboard">‚Üê</a>
                </div>
            </div>

            <!-- ‚úÖ MODAL DE INSIGHTS -->
            {% if insights_pendientes %}
            <div id="insightsModal" class="insights-modal" onclick="cerrarModalInsights(event)">
                <div class="insights-modal-content" onclick="event.stopPropagation()">
                    <div class="insights-modal-header">
                        <h3>üîî Insights Detectados</h3>
                        <button class="close-modal-btn" onclick="cerrarModalInsights()">‚úï</button>
                    </div>
                    
                    <div class="insights-modal-body">
                        {% for insight in insights_pendientes %}
                        <div class="insight-card insight-{{ insight.severidad }}" data-insight-id="{{ insight.id }}">
                            <div class="insight-header">
                                <span class="insight-icon">
                                    {% if insight.severidad == 'critica' %}üö®
                                    {% elif insight.severidad == 'alta' %}‚ö†Ô∏è
                                    {% elif insight.tipo == 'oportunidad' %}üí°
                                    {% elif insight.tipo == 'correlacion' %}üîó
                                    {% else %}üìä{% endif %}
                                </span>
                                <h4>{{ insight.titulo }}</h4>
                            </div>
                            
                            <p class="insight-description">{{ insight.descripcion }}</p>
                            
                            {% if insight.recomendacion %}
                            <div class="insight-recommendation">
                                <strong>üí° Recomendaci√≥n:</strong> {{ insight.recomendacion }}
                            </div>
                            {% endif %}
                            
                            <div class="insight-footer">
                                <span class="insight-time">{{ insight.detectado_en|timesince }} atr√°s</span>
                                <button class="insight-dismiss-btn" onclick="descartarInsight({{ insight.id }})">
                                    Marcar como visto
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="insights-modal-footer">
                        <button class="btn-secondary" onclick="descartarTodosInsights()">
                            Marcar todos como vistos
                        </button>
                        <button class="btn-primary" onclick="cerrarModalInsights()">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- üí¨ √ÅREA DE MENSAJES -->
            <div class="chatbot-messages" id="chatbotMessages">
                {% if mensajes %}
                    {% for msg in mensajes %}
                        <div class="message {{ msg.tipo }}">
                            <div class="message-content">
                                {{ msg.mensaje|safe }}
                                <div class="message-time">{{ msg.fecha|date:"H:i" }}</div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="welcome-message">
                        <h3>¬°Hola! Soy tu asistente</h3>
                        <p>¬øEn qu√© puedo ayudarte hoy?</p>
                        <div class="welcome-suggestions">
                            <div class="suggestion-chip" data-message="¬øCu√°les son los productos m√°s vendidos?">
                                ¬øCu√°les son los productos m√°s vendidos?
                            </div>
                            <div class="suggestion-chip" data-message="Registrar venta">
                                Registrar una venta
                            </div>
                            <div class="suggestion-chip" data-message="¬øQu√© productos necesito reponer?">
                                ¬øQu√© productos necesito reponer?
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- ‚å®Ô∏è INPUT + MIC + ENVIAR -->
            <div class="chatbot-input-area">
                <input 
                    type="text" 
                    class="chatbot-input" 
                    id="chatbotInput" 
                    placeholder="Escribe tu mensaje..."
                    autocomplete="off"
                >

                <button class="chatbot-mic-btn" id="chatbotMic" type="button">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>

                <button class="chatbot-send-btn" id="chatbotSend">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ MODAL DE CONFIRMACI√ìN -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon warning">
                    <span>‚ö†Ô∏è</span>
                </div>
                <h3 class="modal-title" id="modalTitle">Confirmar acci√≥n</h3>
            </div>
            <div class="modal-body" id="modalMessage">
                ¬øEst√°s seguro de realizar esta acci√≥n?
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancelar</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ CONTENEDOR DE NOTIFICACIONES -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        window.CONVERSACION_ID = {{ conversacion_actual.id }};
    </script>
    <script src="{% static 'js/chatbot.js' %}"></script>
</body>
</html>