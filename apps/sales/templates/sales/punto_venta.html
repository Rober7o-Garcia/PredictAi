{% extends "base/base.html" %}
{% load static %}

{% block favicon %}
    https://pngimg.com/uploads/box/box_PNG31.png
{% endblock favicon %}

{% block title_pag %}Punto de Venta - PredictAI üíª{% endblock title_pag %}

{% block css_styles %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'sales/css/sales.css' %}">
{% endblock css_styles %}

{% block content %}
    <body>
        <div class="container-fluid h-100">
            <div class="row h-100">
                <!-- ========================================
                    COLUMNA IZQUIERDA: Scanner + Chatbot
                    ======================================== -->
                <div class="col-md-7 scanner-column">
                    <!-- Header -->
                    <div class="header-pos">
                        <h2>üì∑ Punto de Venta</h2>
                        <button id="toggle-voice-btn" class="btn btn-primary">
                            üé§ Activar Asistente de Voz
                        </button>
                    </div>
                    
                    <!-- Estado del asistente de voz -->
                    <div id="voice-status" class="voice-status d-none">
                        <div class="pulse-indicator"></div>
                        <span id="voice-status-text">Asistente activado - Escuchando...</span>
                    </div>
                    
                    <!-- Selector de c√°mara -->
                    <div id="camera-select-container" class="camera-select-container">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">üì∑ Selecciona tu c√°mara</h5>
                                <p class="card-text text-muted">
                                    Elige la c√°mara que deseas usar para escanear c√≥digos de barras
                                </p>
                                
                                <div class="mb-3">
                                    <label for="camera-selector" class="form-label">
                                        <strong>C√°mara disponible:</strong>
                                    </label>
                                    <select id="camera-selector" class="form-select form-select-lg">
                                        <option value="">Cargando c√°maras...</option>
                                    </select>
                                </div>
                                
                                <button id="start-scanner-btn" class="btn btn-primary btn-lg w-100">
                                    üì∑ Iniciar Scanner
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estado del scanner (despu√©s de iniciar) -->
                    <div id="scanner-status" class="scanner-status-bar d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>üü¢ <span>Scanner activo</span></span>
                            <button id="change-camera-btn" class="btn btn-sm btn-outline-primary">
                                üîÑ Cambiar C√°mara
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scanner de c√≥digo de barras -->
                    <div class="scanner-container">
                        <div id="barcode-reader"></div>
                        <div class="scanner-overlay">
                            <div class="scan-line"></div>
                            <p class="scan-instruction">Coloca el c√≥digo de barras en el marco</p>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n del producto escaneado -->
                    <div id="product-info" class="product-info d-none">
                        <div class="product-card">
                            <h3 id="product-name">-</h3>
                            <p class="product-code">
                                <span style="color: #6b7280;">C√≥digo:</span> 
                                <span id="product-code">-</span>
                            </p>
                            <p class="product-price">
                                <span style="color: #6b7280;">Precio:</span> 
                                $<span id="product-price">0.00</span>
                            </p>
                            <p class="product-stock">
                                <span style="color: #6b7280;">Stock disponible:</span> 
                                <span id="product-stock">0</span>
                            </p>
                            
                            <!-- Input de cantidad (fallback manual) -->
                            <div class="quantity-input">
                                <label>Cantidad:</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" id="qty-minus" type="button">
                                        ‚àí
                                    </button>
                                    <input 
                                        type="number" 
                                        id="quantity" 
                                        class="form-control text-center" 
                                        value="1" 
                                        min="1"
                                        max="999"
                                    >
                                    <button class="btn btn-outline-secondary" id="qty-plus" type="button">
                                        +
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bot√≥n agregar al carrito -->
                            <button id="add-to-cart-btn" class="btn btn-success w-100 mt-3">
                                ‚ûï Agregar al Carrito
                            </button>
                            
                            <p class="text-muted text-center mt-2 mb-0 small">
                                O di en voz alta la cantidad que deseas
                            </p>
                        </div>
                    </div>
                    
                    <!-- Transcript de la conversaci√≥n con el chatbot -->
                    <div class="chatbot-transcript">
                        <h5>üí¨ Conversaci√≥n con el Asistente</h5>
                        <div id="conversation-log" class="conversation-log">
                            <p class="text-muted text-center">
                                Activa el asistente de voz y la conversaci√≥n aparecer√° aqu√≠...
                            </p>
                        </div>
                    </div>
                    
                    <!-- Instrucciones de uso -->
                    <div class="mt-4">
                        <div class="alert alert-info" role="alert">
                            <h6 class="alert-heading">
                                <strong>üí° C√≥mo usar el sistema:</strong>
                            </h6>
                            <ol class="mb-0 small">
                                <li><strong>Activa el asistente de voz</strong> (bot√≥n arriba)</li>
                                <li><strong>Escanea un producto</strong> con la c√°mara</li>
                                <li><strong>Di la cantidad</strong> en voz alta (ej: "3", "cinco")</li>
                                <li><strong>Repite</strong> para m√°s productos</li>
                                <li><strong>Di "terminar venta"</strong> cuando termines</li>
                                <li><strong>Confirma</strong> diciendo "s√≠"</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- ========================================
                    COLUMNA DERECHA: Carrito
                    ======================================== -->
                <div class="col-md-5 cart-column">
                    <!-- Header del carrito -->
                    <div class="cart-header">
                        <h3>üõí Carrito de Venta</h3>
                        <button id="clear-cart-btn" class="btn btn-outline-danger btn-sm">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                    
                    <!-- Items del carrito -->
                    <div id="cart-items" class="cart-items">
                        <p class="text-muted text-center">El carrito est√° vac√≠o</p>
                    </div>
                    
                    <!-- Resumen del carrito -->
                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>$<span id="cart-subtotal">0.00</span></span>
                        </div>
                        <div class="summary-row total">
                            <span>TOTAL:</span>
                            <span class="total-amount">
                                $<span id="cart-total">0.00</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Acciones del carrito -->
                    <div class="cart-actions">
                        <button 
                            id="finalize-sale-btn" 
                            class="btn btn-success btn-lg w-100" 
                            disabled
                        >
                            üí∞ Finalizar Venta
                        </button>
                        <p class="text-muted text-center mt-2 small mb-0">
                            O di: <strong>"Terminar venta"</strong>
                        </p>
                    </div>
                    
                    <!-- Atajos de teclado (opcional) -->
                    <div class="mt-4">
                        <div class="alert alert-secondary small" role="alert">
                            <strong>‚å®Ô∏è Comandos de voz:</strong><br>
                            ‚Ä¢ <strong>"Tres"</strong> ‚Üí Agregar 3 unidades<br>
                            ‚Ä¢ <strong>"Terminar venta"</strong> ‚Üí Ir a pago<br>
                            ‚Ä¢ <strong>"S√≠"</strong> ‚Üí Confirmar venta<br>
                            ‚Ä¢ <strong>"No"</strong> ‚Üí Cancelar<br>
                            ‚Ä¢ <strong>"Quitar √∫ltimo"</strong> ‚Üí Eliminar √∫ltimo item<br>
                            ‚Ä¢ <strong>"Cu√°nto va"</strong> ‚Üí Consultar total
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================
            MODAL DE CONFIRMACI√ìN DE VENTA
            ======================================== -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">
                            üí∞ Confirmar Venta
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center py-3">
                            <p class="mb-2" style="font-size: 1.1rem;">
                                Total a pagar:
                            </p>
                            <p class="mb-4" style="font-size: 2rem; font-weight: 700; color: #10b981;">
                                $<span id="modal-total">0.00</span>
                            </p>
                            <p class="text-muted mb-0">
                                ¬øConfirmas la venta?
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            ‚ùå Cancelar
                        </button>
                        <button type="button" id="confirm-sale-btn" class="btn btn-success btn-lg">
                            ‚úÖ S√≠, Confirmar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% block js_scripts %}
            <!-- html5-qrcode Library -->
            <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            
            <!-- Fallback para navegadores sin soporte de m√≥dulos -->
            <script nomodule>
                alert('Tu navegador no soporta m√≥dulos ES6. Por favor actualiza tu navegador.');
            </script>

            <!-- Custom JS - M√≥dulos ES6 -->
            <script type="module" src="{% static 'sales/js/sales-main.js' %}"></script>
        {% endblock js_scripts %}
    </body>
{% endblock content %}